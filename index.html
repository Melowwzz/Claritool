<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>Claritool — Estude com inteligência</title>
<meta name="description" content="Ferramenta de IA para estudantes. Simplifique textos, gere roteiros de estudo e pratique com um tutor inteligente."/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Figtree:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
/* ═══════════════════════════════════════════
   CLARITOOL — Midnight Study Theme
   ═══════════════════════════════════════════ */

:root {
  --bg:       #0C0C0C;
  --bg2:      #111111;
  --surface:  #161616;
  --surface2: #1C1C1C;
  --surface3: #232323;
  --surface4: #2A2A2A;

  --border:   rgba(255,255,255,.06);
  --border2:  rgba(255,255,255,.10);
  --border3:  rgba(255,255,255,.16);

  --white:    #F5F0EB;
  --text:     #B8B2A8;
  --muted:    #6B655C;
  --dim:      #3D3A35;

  --accent:   #D4A574;
  --accent2:  #C4956A;
  --accent-g: rgba(212,165,116,.08);
  --accent-g2:rgba(212,165,116,.14);

  --ok:       #7BC4A0;
  --ok-g:     rgba(123,196,160,.10);
  --err:      #D4766A;
  --err-g:    rgba(212,118,106,.10);

  --r:   12px;
  --rs:  8px;
  --font: 'Figtree', -apple-system, sans-serif;
  --serif: 'Instrument Serif', Georgia, serif;
  --ease: cubic-bezier(.22,.68,0,1);
}

/* ─── Themes ─── */
[data-theme="mid"] {
  --bg:       #2A2A2A;
  --bg2:      #303030;
  --surface:  #363636;
  --surface2: #3C3C3C;
  --surface3: #434343;
  --surface4: #4A4A4A;
  --border:   rgba(255,255,255,.08);
  --border2:  rgba(255,255,255,.13);
  --border3:  rgba(255,255,255,.20);
  --white:    #F0EDE8;
  --text:     #C5BFB5;
  --muted:    #8A847A;
  --dim:      #5A5650;
}
[data-theme="light"] {
  --bg:       #F5F2ED;
  --bg2:      #EBE8E3;
  --surface:  #FFFFFF;
  --surface2: #F0EDE8;
  --surface3: #E5E2DD;
  --surface4: #DBD8D3;
  --border:   rgba(0,0,0,.08);
  --border2:  rgba(0,0,0,.12);
  --border3:  rgba(0,0,0,.18);
  --white:    #1A1A1A;
  --text:     #4A4540;
  --muted:    #8A847A;
  --dim:      #B5B0A8;
  --accent:   #B8864A;
  --accent2:  #A47840;
  --accent-g: rgba(184,134,74,.08);
  --accent-g2:rgba(184,134,74,.14);
  --ok:       #4A9A72;
  --ok-g:     rgba(74,154,114,.10);
  --err:      #C4564A;
  --err-g:    rgba(196,86,74,.10);
}
[data-theme="light"] .scene-grain { opacity:.012; }
[data-theme="light"] .scene-glow { opacity:.3; }
[data-theme="light"] .scene-dots { background-image:radial-gradient(rgba(0,0,0,.03) 1px,transparent 1px); }
[data-theme="light"] ::selection { color:#fff; }
[data-theme="light"] ::-webkit-scrollbar-thumb { background:rgba(0,0,0,.12); }

/* Theme toggle */
.theme-toggle{
  display:flex;gap:3px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:99px;
  padding:3px;
}
.theme-dot{
  width:22px;height:22px;
  border-radius:50%;
  border:2px solid var(--border2);
  cursor:pointer;
  transition:all .2s var(--ease);
  position:relative;
}
.theme-dot:hover{border-color:var(--accent2)}
.theme-dot.active{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-g2)}
.theme-dot[data-t="dark"]{background:#0C0C0C}
.theme-dot[data-t="mid"]{background:#3C3C3C}
.theme-dot[data-t="light"]{background:#F0EDE8}

/* ─── Reset ─── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth;-webkit-tap-highlight-color:transparent}
body{
  font-family:var(--font);
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  font-size:15px;
  line-height:1.65;
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px}
::selection{background:var(--accent);color:var(--bg)}

/* ─── Ambient Background ─── */
.scene{
  position:fixed;inset:0;
  pointer-events:none;z-index:0;
  overflow:hidden;
}
.scene-grain{
  position:absolute;inset:0;
  opacity:.025;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size:200px;
}
.scene-glow{
  position:absolute;
  border-radius:50%;
  filter:blur(120px);
  animation:glow-drift 25s ease-in-out infinite;
}
.glow-1{
  width:600px;height:600px;
  top:-200px;right:-150px;
  background:radial-gradient(circle,rgba(212,165,116,.04),transparent 70%);
}
.glow-2{
  width:450px;height:450px;
  bottom:-120px;left:-100px;
  background:radial-gradient(circle,rgba(212,165,116,.03),transparent 70%);
  animation-delay:-12s;
  animation-duration:20s;
}
@keyframes glow-drift{
  0%,100%{transform:translate(0,0)}
  40%{transform:translate(25px,-20px)}
  70%{transform:translate(-18px,15px)}
}

/* Subtle dot pattern */
.scene-dots{
  position:absolute;inset:0;
  background-image:radial-gradient(rgba(255,255,255,.02) 1px,transparent 1px);
  background-size:32px 32px;
  mask-image:radial-gradient(ellipse 70% 60% at 50% 30%,black 10%,transparent 70%);
}

/* ─── Layout ─── */
.app{
  position:relative;z-index:1;
  max-width:820px;
  margin:0 auto;
  padding:0 24px 100px;
}

/* ─── Header ─── */
.header{
  display:flex;align-items:center;justify-content:space-between;
  padding:36px 0 28px;
  border-bottom:1px solid var(--border);
  margin-bottom:40px;
  gap:16px;
  animation:rise .6s var(--ease) both;
}
.logo{display:flex;align-items:center;gap:12px;text-decoration:none}
.logo-icon{
  width:36px;height:36px;
  background:var(--surface2);
  border:1px solid var(--border2);
  border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  position:relative;
}
.logo-icon::after{
  content:'';
  width:14px;height:14px;
  background:var(--accent);
  border-radius:50%;
  opacity:.85;
  box-shadow:0 0 12px rgba(212,165,116,.3);
}
.logo-text{
  font-family:var(--serif);
  font-size:1.35rem;
  color:var(--white);
  letter-spacing:-.02em;
}
.logo-badge{
  display:inline-block;
  width:6px;height:6px;
  background:var(--ok);
  border-radius:50%;
  margin-left:6px;
  vertical-align:middle;
  animation:pulse 2.5s ease infinite;
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}

/* ─── Nav Tabs ─── */
.nav{
  display:flex;gap:2px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:4px;
}
.tab-btn{
  flex:1;
  border:none;background:transparent;
  color:var(--muted);
  padding:8px 16px;
  border-radius:var(--rs);
  cursor:pointer;
  font-family:var(--font);
  font-size:.82rem;font-weight:600;
  transition:all .2s var(--ease);
  white-space:nowrap;
  -webkit-appearance:none;
  letter-spacing:.01em;
}
.tab-btn:hover{color:var(--text)}
.tab-btn.active{
  background:var(--surface3);
  color:var(--white);
  box-shadow:0 1px 4px rgba(0,0,0,.3);
}

/* ─── Tab Content ─── */
.tab-content{display:none}
.tab-content.active{display:block;animation:rise .3s var(--ease)}

@keyframes rise{
  from{opacity:0;transform:translateY(12px)}
  to{opacity:1;transform:none}
}

/* ─── Hero Section ─── */
.hero{
  text-align:center;
  padding:48px 0 40px;
  animation:rise .7s var(--ease) both;
  animation-delay:.1s;
}
.hero-label{
  font-size:.72rem;font-weight:600;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.15em;
  margin-bottom:16px;
}
.hero h1{
  font-family:var(--serif);
  font-size:clamp(2rem,5vw,3.2rem);
  color:var(--white);
  line-height:1.15;
  margin-bottom:8px;
  letter-spacing:-.02em;
}
.hero h1 em{
  font-style:italic;
  color:var(--accent);
}
.typing-line{
  display:inline;
  color:var(--accent);
  font-style:italic;
}
.typing-cursor{
  display:inline-block;
  width:2px;height:1em;
  background:var(--accent);
  margin-left:2px;
  vertical-align:text-bottom;
  animation:blink .8s step-end infinite;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.hero-sub{
  font-size:1rem;
  color:var(--muted);
  max-width:480px;
  margin:12px auto 0;
  line-height:1.7;
}

/* ─── Page title ─── */
.page-title{margin-bottom:28px}
.page-title h2{
  font-family:var(--serif);
  font-size:1.5rem;
  color:var(--white);
  margin-bottom:6px;
  letter-spacing:-.01em;
}
.page-title p{font-size:.9rem;color:var(--muted);line-height:1.6}

/* ─── Card ─── */
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:28px;
  transition:border-color .2s;
}
.card:hover{border-color:var(--border2)}

/* ─── Form Elements ─── */
.field{margin-bottom:20px}
.label{
  display:block;
  font-size:.72rem;font-weight:600;
  color:var(--text);
  margin-bottom:8px;
  letter-spacing:.06em;
  text-transform:uppercase;
}
.label-hint{font-weight:400;color:var(--muted);text-transform:none;letter-spacing:0}
.char-count{
  text-align:right;
  font-size:.7rem;color:var(--dim);
  margin-top:4px;
}

textarea,input[type=text]{
  width:100%;
  background:var(--bg2);
  border:1px solid var(--border);
  border-radius:var(--rs);
  color:var(--white);
  font-family:var(--font);
  font-size:.9rem;
  padding:12px 14px;
  transition:all .2s var(--ease);
  outline:none;
  resize:none;
  -webkit-appearance:none;
}
textarea:focus,input[type=text]:focus{
  border-color:var(--accent2);
  background:var(--surface);
  box-shadow:0 0 0 3px rgba(212,165,116,.06);
}
textarea::placeholder,input::placeholder{color:var(--dim)}

/* ─── Buttons ─── */
.btn{
  display:inline-flex;align-items:center;gap:8px;
  padding:10px 20px;
  border-radius:var(--rs);
  border:1px solid var(--border2);
  background:var(--surface2);
  color:var(--text);
  font-family:var(--font);
  font-size:.85rem;font-weight:500;
  cursor:pointer;
  transition:all .2s var(--ease);
  -webkit-appearance:none;
  white-space:nowrap;
}
.btn:hover{border-color:var(--border3);background:var(--surface3);color:var(--white)}
.btn:active{transform:scale(.97)}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none}
.btn-sm{padding:6px 12px;font-size:.78rem}
.btn-primary{
  background:var(--white);
  border-color:transparent;
  color:var(--bg);
  font-weight:600;
}
.btn-primary:hover{background:#fff;box-shadow:0 2px 12px rgba(245,240,235,.15)}
.btn-primary:disabled{opacity:.3;background:var(--white)}
.btn-ghost{
  background:transparent;
  border-color:var(--border);
  color:var(--muted);
}
.btn-ghost:hover{color:var(--white);border-color:var(--border2)}

/* ─── Model Selector ─── */
.model-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:8px;
  margin-bottom:20px;
}
.model-card{
  border:1px solid var(--border);
  background:var(--bg2);
  border-radius:var(--rs);
  padding:14px;
  cursor:pointer;
  transition:all .2s var(--ease);
  position:relative;
}
.model-card:hover{border-color:var(--border2);background:var(--surface)}
.model-card.sel{border-color:var(--accent2);background:var(--accent-g)}
.model-card.sel::after{
  content:'';
  position:absolute;top:12px;right:12px;
  width:7px;height:7px;
  background:var(--accent);
  border-radius:50%;
}
.model-name{font-size:.82rem;font-weight:600;color:var(--white);margin-bottom:3px}
.model-desc{font-size:.72rem;color:var(--muted);line-height:1.45}
.model-tag{
  display:inline-block;margin-top:6px;
  font-size:.62rem;font-weight:700;
  color:var(--accent2);
  letter-spacing:.05em;
  text-transform:uppercase;
}

/* ─── Result Box ─── */
.result{
  margin-top:20px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:24px;
  display:none;
}
.result.vis{display:block;animation:rise .3s var(--ease)}
.result-label{
  font-size:.68rem;font-weight:600;
  text-transform:uppercase;letter-spacing:.12em;
  color:var(--muted);
  margin-bottom:16px;
  display:flex;align-items:center;gap:10px;
}
.result-label::after{content:'';flex:1;height:1px;background:var(--border)}
.result-body{color:var(--text);line-height:1.85;font-size:.9rem}
.result-body strong{color:var(--white);font-weight:600}
.result-body h3{color:var(--accent);margin:16px 0 6px;font-size:.95rem;font-weight:600}
.result-body ul{padding-left:20px;margin:6px 0}
.result-body li{margin:4px 0}
.result-body p{margin:6px 0}
.result-body code{
  background:var(--surface2);
  padding:2px 6px;border-radius:4px;
  font-size:.82em;color:var(--accent);
}

/* Error Box */
.errbox{
  display:none;margin-top:14px;
  padding:12px 16px;
  background:var(--err-g);
  border:1px solid rgba(212,118,106,.2);
  border-radius:var(--rs);
  color:var(--err);font-size:.85rem;
}
.errbox.vis{display:block;animation:rise .2s var(--ease)}

/* ─── Dots Loader ─── */
.dots{display:inline-flex;gap:4px;align-items:center}
.dots span{
  width:4px;height:4px;
  background:var(--muted);border-radius:50%;
  animation:bounce-dot 1s ease infinite;
}
.dots span:nth-child(2){animation-delay:.15s}
.dots span:nth-child(3){animation-delay:.3s}
@keyframes bounce-dot{
  0%,60%,100%{transform:translateY(0);opacity:.3}
  30%{transform:translateY(-5px);opacity:1}
}

/* ─── Tutor Setup ─── */
.setup-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:32px;
}
.setup-card h3{
  font-family:var(--serif);
  font-size:1.15rem;
  color:var(--white);
  margin-bottom:4px;
}
.setup-card>p{font-size:.88rem;color:var(--muted);margin-bottom:28px}

.level-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:20px}
.level-card{
  border:1px solid var(--border);background:var(--bg2);
  border-radius:var(--rs);padding:14px 10px;
  cursor:pointer;text-align:center;transition:all .2s var(--ease);
}
.level-card:hover{border-color:var(--border2)}
.level-card.sel{border-color:var(--accent2);background:var(--accent-g)}
.level-label{font-size:.8rem;font-weight:600;color:var(--white)}
.level-sub{font-size:.7rem;color:var(--muted);margin-top:3px}

.mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px}
.mode-card{
  border:1px solid var(--border);background:var(--bg2);
  border-radius:var(--rs);padding:14px;
  cursor:pointer;transition:all .2s var(--ease);
}
.mode-card:hover{border-color:var(--border2)}
.mode-card.sel{border-color:var(--accent2);background:var(--accent-g)}
.mode-name{font-size:.82rem;font-weight:600;color:var(--white);margin-bottom:3px}
.mode-desc{font-size:.72rem;color:var(--muted);line-height:1.45}

/* ─── Chat Interface ─── */
.chat-wrap{display:flex;gap:16px;align-items:flex-start}
.chat-main{flex:1;min-width:0}
.chat-frame{
  display:flex;flex-direction:column;
  border:1px solid var(--border);
  border-radius:var(--r);
  overflow:hidden;
  box-shadow:0 12px 40px rgba(0,0,0,.4);
}
.chat-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 18px;
  background:var(--surface);
  border-bottom:1px solid var(--border);
  gap:12px;flex-wrap:wrap;
}
.chat-subject{font-weight:600;font-size:.9rem;color:var(--white)}
.chat-meta{font-size:.72rem;color:var(--muted)}
.score-pill{
  display:inline-flex;align-items:center;gap:5px;
  background:var(--accent-g);border:1px solid var(--accent-g2);
  color:var(--accent);font-size:.74rem;font-weight:600;
  padding:3px 10px;border-radius:99px;margin-left:10px;
}

.messages{
  height:440px;overflow-y:auto;
  padding:16px;background:var(--bg);
  display:flex;flex-direction:column;gap:14px;
}
.msg{display:flex;gap:10px;align-items:flex-start;animation:msg-in .25s var(--ease)}
@keyframes msg-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.msg.user{flex-direction:row-reverse}

.avatar{
  width:30px;height:30px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;font-weight:700;flex-shrink:0;
  letter-spacing:.02em;
}
.msg.ai .avatar{background:var(--accent-g2);border:1px solid var(--accent-g2);color:var(--accent)}
.msg.user .avatar{background:var(--surface2);border:1px solid var(--border);color:var(--muted)}

.bubble{
  max-width:78%;padding:12px 15px;
  border-radius:var(--r);font-size:.87rem;line-height:1.7;
}
.msg.ai .bubble{background:var(--surface);border:1px solid var(--border);color:var(--text);border-top-left-radius:3px}
.msg.user .bubble{background:var(--surface2);border:1px solid var(--border2);color:var(--white);border-top-right-radius:3px}
.bubble strong{color:var(--white);font-weight:600}
.bubble h3{color:var(--accent);margin:10px 0 4px;font-size:.88rem;font-weight:600}
.bubble ul{padding-left:16px;margin:5px 0}
.bubble li{margin:3px 0}
.bubble p{margin:5px 0}

/* Question cards */
.q-card{
  background:var(--surface);border:1px solid var(--border2);
  border-radius:var(--r);padding:16px;margin-top:10px;
}
.q-text{font-weight:600;color:var(--white);margin-bottom:12px;font-size:.88rem;line-height:1.55}
.opts{display:flex;flex-direction:column;gap:7px}
.opt-btn{
  border:1px solid var(--border);background:var(--bg2);
  border-radius:var(--rs);padding:10px 13px;
  cursor:pointer;text-align:left;color:var(--text);
  font-family:var(--font);font-size:.84rem;
  transition:all .2s var(--ease);display:flex;gap:10px;align-items:center;
  width:100%;-webkit-appearance:none;
}
.opt-btn:hover:not(:disabled){border-color:var(--border2);background:var(--surface)}
.opt-btn:disabled{cursor:default}
.opt-btn.ok{border-color:var(--ok);background:var(--ok-g);color:var(--ok)}
.opt-btn.er{border-color:var(--err);background:var(--err-g);color:var(--err)}
.opt-key{font-weight:700;font-size:.72rem;color:var(--dim);flex-shrink:0;width:18px}
.opt-btn.ok .opt-key,.opt-btn.er .opt-key{color:inherit}

/* Dissertative */
.dis-area{margin-top:10px}
.dis-area textarea{height:76px}
.dis-row{display:flex;gap:8px;margin-top:10px}

/* Chat input */
.chat-input{
  padding:12px 14px;
  background:var(--surface);
  border-top:1px solid var(--border);
  display:flex;gap:10px;align-items:flex-end;
}
.chat-input textarea{flex:1;height:42px;resize:none}
.chat-input .btn-primary{
  background:var(--surface3);
  border:1px solid var(--border2);
  color:var(--text);
  font-weight:600;
}
.chat-input .btn-primary:hover{
  background:var(--surface4);
  border-color:var(--border3);
  color:var(--white);
  box-shadow:none;
}
.chat-input .btn-primary:disabled{opacity:.3;background:var(--surface3)}

/* ─── Sources sidebar ─── */
.sources{
  width:210px;flex-shrink:0;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:16px;
  position:sticky;top:20px;
}
.sources h4{
  font-size:.7rem;font-weight:700;
  color:var(--muted);
  text-transform:uppercase;letter-spacing:.1em;
  margin-bottom:12px;
}
.source-list{list-style:none}
.source-list li{margin-bottom:10px}
.source-list a{
  color:var(--text);text-decoration:none;
  font-size:.78rem;line-height:1.45;
  display:block;transition:color .2s;
}
.source-list a:hover{color:var(--accent)}
.source-empty{font-size:.74rem;color:var(--dim)}

/* ─── Status Bar ─── */
.status-bar{
  position:fixed;bottom:0;left:0;right:0;
  height:38px;
  background:var(--surface);
  border-top:1px solid var(--border);
  display:flex;align-items:center;
  padding:0 24px;gap:18px;
  z-index:100;
  font-size:.72rem;color:var(--dim);
}
.sb-item{display:flex;align-items:center;gap:6px}
.sb-dot{width:5px;height:5px;border-radius:50%;background:var(--ok)}
.sb-model{margin-left:auto;font-weight:500;color:var(--muted)}

/* ─── Toast ─── */
.toasts{
  position:fixed;bottom:50px;right:24px;
  z-index:999;display:flex;flex-direction:column;gap:8px;
  pointer-events:none;
}
.toast{
  background:var(--surface3);border:1px solid var(--border2);
  color:var(--text);font-size:.82rem;
  padding:10px 16px;border-radius:var(--rs);
  box-shadow:0 8px 24px rgba(0,0,0,.5);
  animation:toast-in .25s var(--ease);
  max-width:280px;
  pointer-events:auto;
}
.toast.ok{border-color:rgba(123,196,160,.3);color:var(--ok)}
.toast.warn{border-color:rgba(212,118,106,.3);color:var(--err)}
@keyframes toast-in{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}
@keyframes toast-out{to{opacity:0;transform:translateX(16px)}}

/* ─── Footer ─── */
.footer{
  text-align:center;
  padding:40px 0 20px;
  font-size:.74rem;
  color:var(--dim);
  border-top:1px solid var(--border);
  margin-top:60px;
}
.footer a{color:var(--muted);text-decoration:none}
.footer a:hover{color:var(--accent)}

/* ─── Mobile ─── */
@media(max-width:680px){
  .app{padding:0 16px 90px}
  .header{padding:18px 0 14px;margin-bottom:20px;flex-wrap:wrap}
  .header .logo{order:0}
  .header .theme-toggle{order:1}
  .header .nav{order:2;width:100%}
  .nav .tab-btn{font-size:.74rem;padding:7px 8px}
  .hero{padding:24px 0 20px}
  .hero h1{font-size:1.6rem}
  .hero-sub{font-size:.88rem}
  .model-grid{grid-template-columns:1fr 1fr}
  .chat-wrap{flex-direction:column}
  .sources{width:100%;position:static;margin-top:12px}
  .messages{height:calc(100dvh - 340px);min-height:280px}
  .bubble{max-width:90%;font-size:.84rem}
  .card,.setup-card{padding:18px}
  .chat-head{padding:10px 14px}
  .chat-subject{font-size:.84rem}
  .chat-input{padding:10px 12px;gap:8px}
  .chat-input textarea{height:38px;font-size:.84rem}
  .q-card{padding:12px}
  .q-text{font-size:.84rem}
  .opt-btn{padding:9px 11px;font-size:.82rem}
  .dis-area textarea{height:68px}
  .toasts{right:12px;bottom:44px;left:12px}
  .toast{max-width:100%}
  .status-bar{padding:0 12px;gap:10px;height:34px;font-size:.68rem}
  .page-title h2{font-size:1.25rem}
  .level-grid{gap:6px}
  .mode-grid{gap:6px}
  .footer{margin-top:40px;padding:24px 0 16px}
}
@media(max-width:400px){
  .app{padding:0 12px 86px}
  .model-grid,.mode-grid{grid-template-columns:1fr}
  .level-grid{grid-template-columns:1fr 1fr}
  .nav .tab-btn{font-size:.68rem;padding:6px 5px}
  .hero h1{font-size:1.4rem}
  .messages{height:calc(100dvh - 320px);min-height:250px}
  .bubble{max-width:94%}
}
</style>
</head>
<body>

<!-- Ambient Background -->
<div class="scene">
  <div class="scene-grain"></div>
  <div class="scene-glow glow-1"></div>
  <div class="scene-glow glow-2"></div>
  <div class="scene-dots"></div>
</div>

<div class="toasts" id="toasts"></div>

<div class="status-bar">
  <span class="sb-item"><span class="sb-dot"></span>Online</span>
  <span class="sb-item">OpenRouter</span>
  <span class="sb-model" id="sb-model"></span>
</div>

<div class="app">

  <!-- HEADER -->
  <header class="header">
    <a class="logo" href="#" onclick="return false">
      <div class="logo-icon"></div>
      <div>
        <span class="logo-text">Claritool</span>
        <span class="logo-badge"></span>
      </div>
    </a>
    <div class="theme-toggle" title="Mudar tema">
      <div class="theme-dot active" data-t="dark" onclick="setTheme('dark')"></div>
      <div class="theme-dot" data-t="mid" onclick="setTheme('mid')"></div>
      <div class="theme-dot" data-t="light" onclick="setTheme('light')"></div>
    </div>
    <nav class="nav" role="tablist">
      <button class="tab-btn active" data-tab="home">Inicio</button>
      <button class="tab-btn" data-tab="simplify">Simplificar</button>
      <button class="tab-btn" data-tab="roadmap">Roteiro</button>
      <button class="tab-btn" data-tab="tutor">Tutor IA</button>
    </nav>
  </header>

  <!-- TAB: HOME -->
  <div id="tab-home" class="tab-content active">
    <div class="hero">
      <div class="hero-label">Ferramenta de estudo com IA</div>
      <h1>
        O lugar certo para<br/>
        <span class="typing-line" id="typing-target"></span><span class="typing-cursor"></span>
      </h1>
      <p class="hero-sub">
        Simplifique textos complexos, crie roteiros de estudo personalizados
        e pratique com um tutor inteligente que se adapta a voce.
      </p>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:12px">
      <div class="card" style="cursor:pointer" onclick="switchTab('simplify')">
        <div style="font-size:1.4rem;margin-bottom:10px">&#9998;</div>
        <div style="font-family:var(--serif);font-size:1.05rem;color:var(--white);margin-bottom:6px">Simplificar</div>
        <div style="font-size:.82rem;color:var(--muted);line-height:1.5">Transforme qualquer texto em algo que todos entendem.</div>
      </div>
      <div class="card" style="cursor:pointer" onclick="switchTab('roadmap')">
        <div style="font-size:1.4rem;margin-bottom:10px">&#9776;</div>
        <div style="font-family:var(--serif);font-size:1.05rem;color:var(--white);margin-bottom:6px">Roteiro</div>
        <div style="font-size:.82rem;color:var(--muted);line-height:1.5">Plano de estudos personalizado com recursos gratuitos.</div>
      </div>
      <div class="card" style="cursor:pointer" onclick="switchTab('tutor')">
        <div style="font-size:1.4rem;margin-bottom:10px">&#9733;</div>
        <div style="font-family:var(--serif);font-size:1.05rem;color:var(--white);margin-bottom:6px">Tutor IA</div>
        <div style="font-size:.82rem;color:var(--muted);line-height:1.5">Aprenda no seu ritmo com explicacoes e questoes adaptativas.</div>
      </div>
    </div>
  </div>

  <!-- TAB: SIMPLIFICAR -->
  <div id="tab-simplify" class="tab-content">
    <div class="page-title">
      <h2>Simplificar texto</h2>
      <p>Cole qualquer texto complexo e receba uma versao clara e acessivel.</p>
    </div>
    <div class="card">
      <div class="field">
        <label class="label">Texto</label>
        <textarea id="sg-in" rows="7" maxlength="15000"
          placeholder="Cole o texto aqui..."
          oninput="document.getElementById('sg-char').textContent=this.value.length"></textarea>
        <div class="char-count"><span id="sg-char">0</span> / 15.000</div>
      </div>
      <button class="btn btn-primary" id="sg-btn" onclick="runSimplify()" style="width:100%">Simplificar texto</button>
    </div>
    <div id="sg-err" class="errbox"></div>
    <div id="sg-res" class="result">
      <div class="result-label">Resultado</div>
      <div id="sg-body" class="result-body"></div>
    </div>
  </div>

  <!-- TAB: ROTEIRO -->
  <div id="tab-roadmap" class="tab-content">
    <div class="page-title">
      <h2>Roteiro de estudos</h2>
      <p>Conte o que quer aprender e receba um plano estruturado e realista.</p>
    </div>
    <div class="card">
      <div class="field">
        <label class="label">O que voce quer aprender?</label>
        <textarea id="rm-goal" rows="3" placeholder="Ex: Python do zero para analise de dados..."></textarea>
      </div>
      <div class="field">
        <label class="label">Prazo disponivel</label>
        <input type="text" id="rm-time" placeholder="Ex: 2 semanas, 1 mes..."/>
      </div>
      <div class="field">
        <label class="label">Contexto adicional <span class="label-hint">(opcional)</span></label>
        <textarea id="rm-ctx" rows="2" placeholder="Ex: Estudo 1h por dia, ja sei Excel basico..."></textarea>
      </div>
      <button class="btn btn-primary" id="rm-btn" onclick="runRoadmap()" style="width:100%">Gerar roteiro</button>
    </div>
    <div id="rm-err" class="errbox"></div>
    <div id="rm-res" class="result">
      <div class="result-label">Roteiro gerado</div>
      <div id="rm-body" class="result-body"></div>
    </div>
  </div>

  <!-- TAB: TUTOR -->
  <div id="tab-tutor" class="tab-content">
    <div class="page-title">
      <h2>Tutor IA</h2>
      <p>Aprendizado guiado com explicacoes, questoes objetivas e dissertativas.</p>
    </div>

    <!-- Setup -->
    <div id="tutor-setup">
      <div class="setup-card">
        <h3>Configurar sessao</h3>
        <p>Configure em segundos — a IA se adapta ao seu perfil automaticamente.</p>

        <div class="field">
          <label class="label">Assunto</label>
          <input type="text" id="t-subj" placeholder="Ex: Fotossintese, Segunda Guerra, Fracoes, Python..."/>
        </div>

        <div class="field">
          <label class="label">Nivel</label>
          <div class="level-grid" id="lg">
            <div class="level-card" data-l="Iniciante" onclick="pickL(this)">
              <div class="level-label">Iniciante</div>
              <div class="level-sub">Sem base previa</div>
            </div>
            <div class="level-card sel" data-l="Intermediario" onclick="pickL(this)">
              <div class="level-label">Intermediario</div>
              <div class="level-sub">Ja tenho nocao</div>
            </div>
            <div class="level-card" data-l="Avancado" onclick="pickL(this)">
              <div class="level-label">Avancado</div>
              <div class="level-sub">Quero aprofundar</div>
            </div>
          </div>
        </div>

        <div class="field">
          <label class="label">Modo</label>
          <div class="mode-grid" id="mog">
            <div class="mode-card sel" data-mo="explicacao" onclick="pickMo(this)">
              <div class="mode-name">Explicacao + Pratica</div>
              <div class="mode-desc">A IA explica e propoe questoes intercaladas</div>
            </div>
            <div class="mode-card" data-mo="questoes" onclick="pickMo(this)">
              <div class="mode-name">Modo Prova</div>
              <div class="mode-desc">So questoes com feedback direto</div>
            </div>
          </div>
        </div>

        <div class="field">
          <label class="label">Tipo de questao</label>
          <div class="mode-grid" id="qtg">
            <div class="mode-card sel" data-qt="mista" onclick="pickQt(this)">
              <div class="mode-name">Mista</div>
              <div class="mode-desc">Objetivas e dissertativas alternadas</div>
            </div>
            <div class="mode-card" data-qt="objetiva" onclick="pickQt(this)">
              <div class="mode-name">So objetiva</div>
              <div class="mode-desc">Multipla escolha com correcao imediata</div>
            </div>
          </div>
        </div>

        <div id="setup-err" class="errbox"></div>
        <button class="btn btn-primary" style="width:100%" onclick="startTutor()">Iniciar sessao</button>
      </div>
    </div>

    <!-- Chat -->
    <div id="tutor-chat" style="display:none">
      <div class="chat-wrap">
        <div class="chat-main">
          <div class="chat-frame">
            <div class="chat-head">
              <div>
                <span class="chat-subject" id="t-slabel">—</span>
                <span class="score-pill">+<span id="score">0</span> pts</span>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <span class="chat-meta" id="t-mlabel"></span>
                <button class="btn btn-sm btn-ghost" onclick="resetTutor()">Reiniciar</button>
              </div>
            </div>
            <div class="messages" id="msgs"></div>
            <div class="chat-input">
              <textarea id="ci" placeholder="Escreva sua mensagem..."
                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg()}"></textarea>
              <button class="btn btn-primary btn-sm" id="send-btn" onclick="sendMsg()">Enviar</button>
            </div>
          </div>
        </div>
        <aside class="sources">
          <h4>Referencias</h4>
          <ul class="source-list" id="sl"></ul>
          <div id="se" class="source-empty">Aparece conforme o assunto.</div>
        </aside>
      </div>
    </div>
  </div>

  <div class="footer">
    Claritool &mdash; Feito para estudantes que querem ir alem.
  </div>

</div>

<script>
/* ══════════════════════════════════════════════
   CLARITOOL — JavaScript
   ══════════════════════════════════════════════ */

/* ── Typing Animation ── */
;(function(){
  const phrases = [
    'aprender com clareza',
    'entender o que importa',
    'praticar sem pressao',
    'estudar com inteligencia',
    'simplificar o complexo',
    'criar seu proprio ritmo'
  ]
  const el = document.getElementById('typing-target')
  let pi = 0, ci = 0, deleting = false
  function tick() {
    const phrase = phrases[pi]
    if (!deleting) {
      el.textContent = phrase.slice(0, ci + 1)
      ci++
      if (ci >= phrase.length) {
        deleting = true
        setTimeout(tick, 2200)
        return
      }
      setTimeout(tick, 55 + Math.random() * 35)
    } else {
      el.textContent = phrase.slice(0, ci)
      ci--
      if (ci < 0) {
        deleting = false
        ci = 0
        pi = (pi + 1) % phrases.length
        setTimeout(tick, 400)
        return
      }
      setTimeout(tick, 25 + Math.random() * 15)
    }
  }
  setTimeout(tick, 800)
})()

/* ── Theme ── */
function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t)
  document.querySelectorAll('.theme-dot').forEach(d => d.classList.toggle('active', d.dataset.t === t))
  try { localStorage.setItem('claritool-theme', t) } catch(e) {}
}
;(function(){
  try {
    const saved = localStorage.getItem('claritool-theme')
    if (saved && ['dark','mid','light'].includes(saved)) setTheme(saved)
  } catch(e) {}
})()

/* ── Tabs ── */
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'))
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'))
  const btn = document.querySelector(`.tab-btn[data-tab="${name}"]`)
  if (btn) btn.classList.add('active')
  document.getElementById('tab-' + name).classList.add('active')
}
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab))
})

/* ── Selectors ── */
function getM() { return 'llama-3.3-70b-versatile' }
function pickL(c) { document.querySelectorAll('#lg .level-card').forEach(x => x.classList.remove('sel')); c.classList.add('sel') }
function pickMo(c) { document.querySelectorAll('#mog .mode-card').forEach(x => x.classList.remove('sel')); c.classList.add('sel') }
function pickQt(c) { document.querySelectorAll('#qtg .mode-card').forEach(x => x.classList.remove('sel')); c.classList.add('sel') }

/* ── Markdown (simple) ── */
function md(t) {
  return t
    .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/^#{1,3} (.+)$/gm, '<h3>$1</h3>')
    .replace(/^[-•] (.+)$/gm, '<li>$1</li>')
    .replace(/((<li>.*<\/li>\s*)+)/g, '<ul>$1</ul>')
    .replace(/\n\n+/g, '<br/><br/>')
    .replace(/\n/g, '<br/>')
}

/* ── Toast ── */
function toast(msg, type = '') {
  const t = document.createElement('div')
  t.className = 'toast' + (type ? ' ' + type : '')
  t.textContent = msg
  document.getElementById('toasts').appendChild(t)
  setTimeout(() => {
    t.style.animation = 'toast-out .25s forwards'
    setTimeout(() => t.remove(), 250)
  }, 3500)
}

/* ── Button state ── */
function setBtn(id, loading, label) {
  const b = document.getElementById(id)
  b.disabled = loading
  b.innerHTML = loading
    ? '<span class="dots"><span></span><span></span><span></span></span> ' + label
    : label
}

/* ── Status bar ── */
function setStatus(model) {
  const sb = document.getElementById('sb-model')
  if (!model) { sb.textContent = ''; return }
  sb.textContent = MODEL_NAMES[model] || model.split('/').pop().split(':')[0]
}

/* ── API URL — Aponte para seu Cloudflare Worker ── */
const API_URL = 'https://claritool-worker.bpmasutti.workers.dev'

/* ── Fallback models (Groq) ── */
const FALLBACK_MODELS = [
  'llama-3.3-70b-versatile',
  'llama-3.1-70b-versatile',
  'mixtral-8x7b-32768',
  'gemma2-9b-it',
  'llama-3.1-8b-instant',
]

/* ── Throttle: evita rajadas de requests ── */
let _lastCallTime = 0
const MIN_CALL_INTERVAL = 1000

/* ── Nomes amigáveis dos modelos ── */
const MODEL_NAMES = {
  'llama-3.3-70b-versatile': 'Llama 3.3 70B',
  'llama-3.1-70b-versatile': 'Llama 3.1 70B',
  'mixtral-8x7b-32768': 'Mixtral 8x7B',
  'gemma2-9b-it': 'Gemma 2 9B',
  'llama-3.1-8b-instant': 'Llama 8B',
}

/* ── API call with auto-retry + model fallback ── */
async function callAI(model, messages, _attempt = 1, _triedModels = []) {
  const MAX_RETRIES = 5

  // Throttle: espera intervalo mínimo entre chamadas
  const now = Date.now()
  const elapsed = now - _lastCallTime
  if (elapsed < MIN_CALL_INTERVAL) {
    await new Promise(ok => setTimeout(ok, MIN_CALL_INTERVAL - elapsed))
  }
  _lastCallTime = Date.now()

  let r, d
  try {
    r = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model, messages })
    })
    d = await r.json()
  } catch (networkErr) {
    if (_attempt < MAX_RETRIES) {
      const delay = Math.min(_attempt * 3000, 15000)
      toast(`Erro de conexão. Tentando em ${Math.round(delay/1000)}s...`)
      await new Promise(ok => setTimeout(ok, delay))
      return callAI(model, messages, _attempt + 1, _triedModels)
    }
    throw new Error('Falha na conexão com o servidor. Verifique sua internet.')
  }

  // 429: tenta modelo alternativo antes de esperar
  if (r.status === 429) {
    _triedModels.push(model)
    // Busca próximo modelo que ainda não foi tentado
    const nextModel = FALLBACK_MODELS.find(m => !_triedModels.includes(m))
    if (nextModel) {
      toast(`${MODEL_NAMES[model] || model} ocupado. Tentando ${MODEL_NAMES[nextModel] || nextModel}...`)
      await new Promise(ok => setTimeout(ok, 1500))
      return callAI(nextModel, messages, 1, _triedModels)
    }
    // Todos os modelos tentados — espera e recomeça
    if (_attempt < MAX_RETRIES) {
      const delay = Math.min(Math.pow(2, _attempt) * 3000, 30000)
      toast(`Todos os modelos ocupados. Aguardando ${Math.round(delay/1000)}s...`)
      await new Promise(ok => setTimeout(ok, delay))
      return callAI(FALLBACK_MODELS[0], messages, _attempt + 1, [])
    }
    throw new Error('Modelos ocupados no momento. Tente novamente em alguns minutos.')
  }

  if (!r.ok) throw new Error(d.error || 'Erro na API (' + r.status + ')')
  if (d.usedModel && d.usedModel !== model) {
    toast('Modelo alternativo: ' + (MODEL_NAMES[d.usedModel] || d.usedModel))
  }
  setStatus(d.usedModel || model)
  return d.result
}

/* ══ SIMPLIFICAR ══ */
async function runSimplify() {
  const text = document.getElementById('sg-in').value.trim()
  const errEl = document.getElementById('sg-err')
  errEl.classList.remove('vis')
  if (text.length < 10) {
    errEl.textContent = 'Cole um texto com pelo menos 10 caracteres.'
    errEl.classList.add('vis'); return
  }
  setBtn('sg-btn', true, 'Processando...')
  document.getElementById('sg-res').classList.remove('vis')
  try {
    const r = await callAI(getM(), [{
      role: 'user',
      content: `Voce e especialista em comunicacao clara. Simplifique o texto abaixo para que qualquer pessoa entenda, sem conhecimento tecnico. Use frases curtas, substitua termos dificeis por equivalentes simples, e destaque os pontos principais ao final com um breve resumo.\n\nTexto:\n${text}\n\nResponda em portugues brasileiro.`
    }])
    document.getElementById('sg-body').innerHTML = md(r)
    document.getElementById('sg-res').classList.add('vis')
    toast('Texto simplificado', 'ok')
  } catch(e) {
    errEl.textContent = e.message; errEl.classList.add('vis')
    toast(e.message, 'warn')
  }
  setBtn('sg-btn', false, 'Simplificar texto')
}

/* ══ ROTEIRO ══ */
async function runRoadmap() {
  const goal = document.getElementById('rm-goal').value.trim()
  const time = document.getElementById('rm-time').value.trim()
  const ctx  = document.getElementById('rm-ctx').value.trim()
  const errEl = document.getElementById('rm-err')
  errEl.classList.remove('vis')
  if (!goal) { errEl.textContent = 'Descreva o que voce quer aprender.'; errEl.classList.add('vis'); return }
  if (!time) { errEl.textContent = 'Informe o prazo disponivel.'; errEl.classList.add('vis'); return }
  setBtn('rm-btn', true, 'Gerando...')
  document.getElementById('rm-res').classList.remove('vis')
  try {
    const r = await callAI(getM(), [{
      role: 'user',
      content: `Voce e pedagogo especialista em aprendizagem acelerada. Crie um roteiro de estudos detalhado, realista e motivador.\n\nObjetivo: ${goal}\nPrazo: ${time}${ctx ? '\nContexto: ' + ctx : ''}\n\nEstruture com fases claras, inclua recursos gratuitos (YouTube, sites, livros), e adicione dicas praticas. Responda em portugues brasileiro.`
    }])
    document.getElementById('rm-body').innerHTML = md(r)
    document.getElementById('rm-res').classList.add('vis')
    toast('Roteiro gerado', 'ok')
  } catch(e) {
    errEl.textContent = e.message; errEl.classList.add('vis')
    toast(e.message, 'warn')
  }
  setBtn('rm-btn', false, 'Gerar roteiro')
}

/* ══ FONTES ══ */
const SOURCES = [
  { kw: ['fotossintese','fotossíntese','cloroplasto'], links: [
    { n: 'Khan Academy — Fotossintese', u: 'https://pt.khanacademy.org/science/ap-biology/cellular-energetics' },
    { n: 'Wikipedia — Fotossintese', u: 'https://pt.wikipedia.org/wiki/Fotoss%C3%ADntese' },
    { n: 'So Biologia', u: 'https://www.sobiologia.com.br' }]},
  { kw: ['segunda guerra','nazismo','hitler'], links: [
    { n: 'Khan Academy — Historia', u: 'https://pt.khanacademy.org/humanities/world-history' },
    { n: 'Brasil Escola — 2a GM', u: 'https://brasilescola.uol.com.br/historiag/segunda-guerra-mundial.htm' }]},
  { kw: ['fracao','fracoes','frações','fração','numerador'], links: [
    { n: 'Khan Academy — Fracoes', u: 'https://pt.khanacademy.org/math/arithmetic/fraction-arithmetic' },
    { n: 'Brasil Escola — Fracoes', u: 'https://brasilescola.uol.com.br/matematica/fracoes.htm' }]},
  { kw: ['python','programacao','programação','codigo','código','algoritmo'], links: [
    { n: 'Python.org (PT)', u: 'https://docs.python.org/pt-br/3/tutorial/' },
    { n: 'W3Schools — Python', u: 'https://www.w3schools.com/python/' }]},
  { kw: ['celula','célula','mitose','meiose','dna','genetica','genética'], links: [
    { n: 'Khan Academy — Biologia', u: 'https://pt.khanacademy.org/science/ap-biology' },
    { n: 'So Biologia', u: 'https://www.sobiologia.com.br' }]},
  { kw: ['fisica','física','forca','força','velocidade','energia','newton'], links: [
    { n: 'Khan Academy — Fisica', u: 'https://pt.khanacademy.org/science/physics' },
    { n: 'Brasil Escola — Fisica', u: 'https://brasilescola.uol.com.br/fisica' }]},
  { kw: ['quimica','química','atomo','átomo','reacao','reação','tabela periodica','tabela periódica'], links: [
    { n: 'Khan Academy — Quimica', u: 'https://pt.khanacademy.org/science/chemistry' },
    { n: 'Brasil Escola — Quimica', u: 'https://brasilescola.uol.com.br/quimica' }]},
  { kw: ['algebra','álgebra','equacao','equação','funcao','função','geometria','matematica','matemática'], links: [
    { n: 'Khan Academy — Matematica', u: 'https://pt.khanacademy.org/math' },
    { n: 'Brasil Escola — Matematica', u: 'https://brasilescola.uol.com.br/matematica' }]},
]

function updateSources(subj) {
  const low = subj.toLowerCase()
  let links = []
  for (const e of SOURCES) if (e.kw.some(k => low.includes(k))) { links = e.links; break }
  if (!links.length) links = [
    { n: 'Khan Academy (PT)', u: 'https://pt.khanacademy.org/' },
    { n: 'Brasil Escola', u: 'https://brasilescola.uol.com.br/' },
    { n: 'Wikipedia (PT)', u: 'https://pt.wikipedia.org/' },
  ]
  document.getElementById('sl').innerHTML =
    links.map(l => `<li><a href="${l.u}" target="_blank" rel="noopener">${l.n}</a></li>`).join('')
  document.getElementById('se').style.display = 'none'
}

/* ══ TUTOR STATE ══ */
let T = {}

function buildSys() {
  const mDesc = T.mode === 'explicacao'
    ? 'Explique o conteudo de forma clara e didatica. Apos CADA bloco de explicacao, SEMPRE proponha UMA questao de fixacao.'
    : 'Va direto as questoes, sem explicacao previa. Corrija com feedback detalhado.'

  const qDesc = T.qtype === 'objetiva'
    ? 'Use SEMPRE questoes de multipla escolha (4 alternativas A/B/C/D).'
    : 'Alterne entre multipla escolha e questoes dissertativas.'

  return `Voce e um tutor educacional para estudantes brasileiros.
Assunto: "${T.subject}". Nivel: ${T.level}.

${mDesc}
${qDesc}

REGRAS OBRIGATORIAS:
1. SEMPRE inclua uma questao ao final de cada resposta. Nunca termine sem uma questao.
2. Se o aluno acertou, parabenize brevemente e IMEDIATAMENTE faca a PROXIMA questao sobre o proximo topico.
3. Se o aluno errou, explique por que a resposta esta errada, explique a resposta correta, e IMEDIATAMENTE faca outra questao.
4. Nunca pergunte "quer continuar?" ou "posso fazer outra pergunta?". Simplesmente CONTINUE automaticamente.
5. Mantenha um fluxo continuo de ensino e avaliacao.

FORMATO de questao OBJETIVA (use EXATAMENTE este formato):
[Q_OBJ]
Enunciado da questao
A) alternativa
B) alternativa
C) alternativa
D) alternativa
[GAB:X]
[/Q_OBJ]

FORMATO de questao DISSERTATIVA (use EXATAMENTE este formato):
[Q_DIS]
Enunciado dissertativo
[/Q_DIS]

Seja claro e direto. Adapte vocabulario ao nivel. Responda em portugues brasileiro.
LEMBRETE FINAL: Sempre termine sua resposta com uma questao no formato correto.`
}

/* ══ TUTOR ACTIONS ══ */
async function startTutor() {
  const subj = document.getElementById('t-subj').value.trim()
  const errEl = document.getElementById('setup-err')
  errEl.classList.remove('vis')
  if (!subj) {
    errEl.textContent = 'Informe o assunto para comecar.'
    errEl.classList.add('vis'); return
  }
  T = {
    messages: [],
    model:   getM(),
    subject: subj,
    level:   (document.querySelector('#lg .level-card.sel') || {}).dataset?.l || 'Intermediario',
    mode:    (document.querySelector('#mog .mode-card.sel') || {}).dataset?.mo || 'explicacao',
    qtype:   (document.querySelector('#qtg .mode-card.sel') || {}).dataset?.qt || 'mista',
    score: 0,
    busy: false,
    questionCount: 0,
  }
  document.getElementById('t-slabel').textContent = subj
  document.getElementById('t-mlabel').textContent = T.level + ' · ' + (T.mode === 'explicacao' ? 'Explicacao + Pratica' : 'Modo Prova')
  document.getElementById('score').textContent = '0'
  document.getElementById('msgs').innerHTML = ''
  document.getElementById('tutor-setup').style.display = 'none'
  document.getElementById('tutor-chat').style.display = 'block'
  updateSources(subj)

  // System message como primeira mensagem do user (OpenRouter nao suporta system em todos os modelos)
  T.messages.push({
    role: 'user',
    content: buildSys() + '\n\n---\n\nOla! Quero aprender sobre "' + subj + '". Pode comecar!'
  })
  await aiTurn(true)
}

function resetTutor() {
  document.getElementById('tutor-setup').style.display = 'block'
  document.getElementById('tutor-chat').style.display = 'none'
  T = {}
  setStatus(null)
}

function addBubble(role, html, isHtml) {
  const wrap = document.getElementById('msgs')
  const d = document.createElement('div')
  d.className = 'msg ' + (role === 'ai' ? 'ai' : 'user')
  d.innerHTML = `<div class="avatar">${role === 'ai' ? 'IA' : 'EU'}</div><div class="bubble"></div>`
  wrap.appendChild(d)
  const bbl = d.querySelector('.bubble')
  bbl.innerHTML = isHtml ? html : md(html)
  wrap.scrollTop = wrap.scrollHeight
  return bbl
}

function showTyping() {
  const wrap = document.getElementById('msgs')
  const d = document.createElement('div')
  d.className = 'msg ai'; d.id = 'typing-indicator'
  d.innerHTML = '<div class="avatar">IA</div><div class="bubble"><span class="dots"><span></span><span></span><span></span></span></div>'
  wrap.appendChild(d)
  wrap.scrollTop = wrap.scrollHeight
}
function hideTyping() { const t = document.getElementById('typing-indicator'); if (t) t.remove() }

function cleanTags(t) {
  // Remove TODAS as tags de questao que sobrarem no texto
  return t
    .replace(/\[Q_OBJ\]/gi, '')
    .replace(/\[\/Q_OBJ\]/gi, '')
    .replace(/\[Q_DIS\]/gi, '')
    .replace(/\[\/Q_DIS\]/gi, '')
    .replace(/\[GAB:[A-D]\]/gi, '')
    .trim()
}

function renderResp(text) {
  // Verifica questao objetiva — regex flexivel
  const om = text.match(/\[Q_OBJ\]\s*([\s\S]*?)\[GAB:\s*([ABCD])\s*\][\s\S]*?\[\/Q_OBJ\]/i)
  if (om) {
    const lines = om[1].trim().split('\n').map(l => l.trim()).filter(Boolean)
    const enunc = lines[0]
    const opts = lines.slice(1).filter(l => /^[A-D]\)/.test(l))
    const gab = om[2]
    const uid = 'q' + Date.now()
    let before = text.replace(/\[Q_OBJ\][\s\S]*?\[\/Q_OBJ\]/i, '')
    before = cleanTags(before)
    const html = (before ? md(before) + '<br/><br/>' : '') +
      `<div class="q-card"><div class="q-text">${enunc}</div><div class="opts" id="${uid}">` +
      opts.map(o =>
        `<button class="opt-btn" data-l="${o[0]}" onclick="ansObj(this,'${gab}','${uid}')">` +
        `<span class="opt-key">${o[0]}</span>${o.slice(2).trim()}</button>`
      ).join('') + '</div></div>'
    addBubble('ai', html, true)
    T.busy = true
    T.questionCount++
    return
  }

  // Verifica questao dissertativa — regex flexivel
  const dm = text.match(/\[Q_DIS\]\s*([\s\S]*?)\[\/Q_DIS\]/i)
  if (dm) {
    const enunc = dm[1].trim()
    let before = text.replace(/\[Q_DIS\][\s\S]*?\[\/Q_DIS\]/i, '')
    before = cleanTags(before)
    const uid = 'da' + Date.now()
    const html = (before ? md(before) + '<br/><br/>' : '') +
      `<div class="q-card"><div class="q-text">${md(enunc)}</div>` +
      `<div class="dis-area"><textarea id="${uid}" placeholder="Escreva sua resposta..."></textarea>` +
      `<div class="dis-row"><button class="btn btn-primary btn-sm" id="btn-${uid}" onclick="ansDis('${uid}')">Enviar resposta</button></div></div></div>`
    addBubble('ai', html, true)
    T.busy = true
    T.questionCount++
    return
  }

  // Texto comum — limpa qualquer tag residual antes de exibir
  const cleaned = cleanTags(text)
  addBubble('ai', cleaned, false)
  T.busy = false
}

function ansObj(btn, gab, listId) {
  if (T.busy === false) return
  document.querySelectorAll('#' + listId + ' .opt-btn').forEach(b => b.disabled = true)
  const acerto = btn.dataset.l === gab
  btn.classList.add(acerto ? 'ok' : 'er')
  if (!acerto) {
    document.querySelectorAll('#' + listId + ' .opt-btn').forEach(b => {
      if (b.dataset.l === gab) b.classList.add('ok')
    })
  }
  T.busy = false
  if (acerto) {
    T.score += 10
    document.getElementById('score').textContent = T.score
    toast('+10 pts', 'ok')
  } else {
    toast('Resposta incorreta', 'warn')
  }

  // Feedback com instrucao explicita para continuar
  const fbMsg = acerto
    ? `Marquei ${btn.dataset.l} e acertei! Continue com a proxima questao.`
    : `Marquei ${btn.dataset.l} mas errei. A correta era ${gab}. Explique por que e faca a proxima questao.`

  T.messages.push({ role: 'user', content: fbMsg })
  setTimeout(() => aiTurn(false), 500)
}

async function ansDis(taId) {
  const ta = document.getElementById(taId)
  const btn = document.getElementById('btn-' + taId)
  if (!ta || !btn) return
  const resp = ta.value.trim()
  if (!resp) return
  ta.disabled = true; btn.disabled = true
  T.busy = false
  addBubble('user', resp, false)
  T.messages.push({ role: 'user', content: 'Minha resposta dissertativa: ' + resp + '\n\nAvalie minha resposta e em seguida faca a proxima questao.' })
  T.score += 5
  document.getElementById('score').textContent = T.score
  toast('+5 pts', 'ok')
  await aiTurn(false)
}

async function sendMsg() {
  const inp = document.getElementById('ci')
  const txt = inp.value.trim()
  if (!txt) return
  // Se tinha questão pendente, cancela (usuario escolheu digitar livremente)
  if (T.busy) {
    T.busy = false
    // Desabilita botoes de questao ativa se houver
    document.querySelectorAll('.q-card .opt-btn:not(:disabled)').forEach(b => b.disabled = true)
    document.querySelectorAll('.dis-area textarea:not(:disabled)').forEach(ta => ta.disabled = true)
    document.querySelectorAll('.dis-area .btn:not(:disabled)').forEach(b => b.disabled = true)
  }
  addBubble('user', txt, false)
  T.messages.push({ role: 'user', content: txt })
  inp.value = ''
  await aiTurn(false)
}

async function aiTurn(isFirst) {
  const sendBtn = document.getElementById('send-btn')
  if (sendBtn) sendBtn.disabled = true
  showTyping()

  // Monta payload com system prompt embutido no historico
  let payload
  if (isFirst) {
    payload = T.messages.slice(-16)
  } else {
    // Sempre inclui o system prompt no inicio do historico para manter contexto
    const sysMsg = { role: 'user', content: buildSys() }
    const sysReply = { role: 'assistant', content: 'Entendido. Vou seguir todas as regras e sempre incluir questoes no formato correto.' }
    const recentHist = T.messages.slice(-12)
    payload = [sysMsg, sysReply, ...recentHist]
  }

  try {
    const resp = await callAI(T.model, payload)
    hideTyping()
    T.messages.push({ role: 'assistant', content: resp })
    renderResp(resp)
    document.getElementById('msgs').scrollTop = document.getElementById('msgs').scrollHeight
  } catch(e) {
    hideTyping()
    addBubble('ai', 'Erro: ' + e.message, false)
    toast(e.message, 'warn')
    T.busy = false
  }
  if (sendBtn) sendBtn.disabled = false
}
</script>
</body>
</html>
